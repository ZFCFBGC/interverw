HTTP/2 是 HTTP 协议自 1999 年 HTTP 1.1 发布后的首个更新，主要基于 SPDY 协议。
那 HTTP/2 到底有哪些具体变化呢？
HTTP2.0 的特点是：在不改动 HTTP 语义、方法、状态码、URI 及首部字段的情况下，大幅度提高了 web 性能。

## 什么是 SPDY 协议

刚刚对 HTTP2.0 的介绍中引出了一个名词 —— SPDY 协议，这又是什么呢？

`SPDY` 是 `Speedy` 的昵音，意为“更快”。它是 Google 开发的基于 `TCP` 协议的应用层协议。目标是优化 `HTTP` 协议的性能，通过压缩、多路复用和优先级等技术，缩短网页的加载时间并提高安全性。`SPDY` 协议的核心思想是尽量减少 `TCP` 连接数。`SPDY` 并不是一种用于替代 `HTTP` 的协议，而是对 `HTTP` 协议的增强。

## HTTP1.x 的缺点

任何事物的更新都是为了弥补或修复上个版本的某些问题，那么我们来看看 HTTP1.x 都有哪些缺点以至于我们要使用 HTTP2.0。

HTTP1.x 有以下几个主要缺点：

- HTTP/1.0 一次只允许在一个 TCP 连接上发起一个请求，HTTP/1.1 使用的流水线技术也只能部分处理请求并发，仍然会存在队列头阻塞问题，因此客户端在需要发起多次请求时，通常会采用建立多连接来减少延迟。
- 单向请求，只能由客户端发起。
- 请求报文与响应报文首部信息冗余量大。
- 数据未压缩，导致数据的传输量大。

我们可以通过一个链接来对比一下 HTTP2.0 到底比 HTTP1.x 快了多少。[链接地址](https://http2.akamai.com/demo)

## HTTP2.0 特点

通过以上内容，你应该已经对 HTTP2.0 有了初步认识，并且了解了 HTTP1.x 的缺点。那么下面我们就来了解一下 HTTP2.0 的特点。

### 二进制传输

HTTP2.0 中所有加强性能的核心是二进制传输，在 HTTP1.x 中，我们是通过文本的方式传输数据。基于文本的方式传输数据存在很多缺陷，文本的表现形式有多样性，因此要做到健壮性考虑的场景必然有很多，但是二进制则不同，只有 0 和 1 的组合，因此选择了二进制传输，实现方便且健壮。
在 HTTP2.0 中引入了新的编码机制，所有传输的数据都会被分割，并采用二进制格式编码。
![](https://github.com/fyuanfen/note/raw/master/images/network/http2-4.jpg)
为了保证 HTTP 不受影响，那就需要在应用层（HTTP2.0）和传输层（TCP or UDP）之间增加一个二进制分帧层。在二进制分帧层上，HTTP2.0 会将所有传输的信息分为更小的消息和帧，并采用二进制格式编码，其中 HTTP1.x 的首部信息会被封装到 Headers 帧，而 Request Body 则封装到 Data 帧。

### 多路复用

在 HTTP1.0 中，我们经常会使用到雪碧图、使用多个域名等方式来进行优化，都是因为浏览器限制了同一个域名下的请求数量，当页面需要请求很多资源的时候，队头阻塞（Head of line blocking）会导致在达到最大请求时，资源需要等待其他资源请求完成后才能继续发送。
HTTP2.0 中，有两个概念非常重要：帧（frame）和流（stream）。

- 帧：HTTP/2 数据通信的最小单位消息：指 HTTP/2 中逻辑上的 HTTP 消息。例如请求和响应等，消息由一个或多个帧组成。

- 流：存在于连接中的一个虚拟通道。流可以承载双向消息，每个流都有一个唯一的整数 ID。

所谓多路复用，即在一个 TCP 连接中存在多个流，即可以同时发送多个请求，对端可以通过帧中的表示知道该帧属于哪个请求。在客户端，这些帧乱序发送，到对端后再根据每个帧首部的流标识符重新组装。通过该技术，可以避免 HTTP 旧版本的队头阻塞问题，极大提高传输性能。

HTTP 1.x 中，如果想并发多个请求，必须使用多个 TCP 链接，且浏览器为了控制资源，还会对单个域名有 6-8 个的 TCP 链接请求限制，如下图，红色圈出来的请求就因域名链接数已超过限制，而被挂起等待了一段时间：
![](https://github.com/fyuanfen/note/raw/master/images/network/http2.jpg)
在 HTTP/2 中，有了二进制分帧之后，HTTP /2 不再依赖 TCP 链接去实现多流并行了，在 HTTP/2 中：

- 同域名下所有通信都在单个连接上完成。
- 单个连接可以承载任意数量的双向数据流。
- 数据流以消息的形式发送，而消息又由一个或多个帧组成，多个帧之间可以乱序发送，因为根据帧首部的流标识可以重新组装。
  这一特性，使性能有了极大提升：

- **同个域名只需要占用一个 TCP 连接**，消除了因多个 TCP 连接而带来的延时和内存消耗。
- 单个连接上可以并行交错的请求和响应，之间互不干扰。
- 在 HTTP/2 中，每个请求都可以带一个 31bit 的优先值，0 表示最高优先级， 数值越大优先级越低。有了这个优先值，客户端和服务器就可以在处理不同的流时采取不同的策略，以最优的方式发送流、消息和帧。

### 所有的 HTTP2.0 的请求都在一个 TCP 链接上

`HTTP 2.0` 把 `HTTP` 协议通信的基本单位缩小为一个一个的帧，这些帧对应 着逻辑流中的消息。并行地在同一个 `TCP` 连接上双向交换消息。就好比，我请求一个页面http://www.qq.com。页面上所有的资源请求都是客户端与服务器上的一条TCP上请求和响应的！ 有关注 `TCP` 性能的同学就会知道，HTTP 性能瓶颈关键在于低延迟而不是高带宽！大多数 `HTTP` 连接的时间都很短，而且是突发性的，但 `TCP` 只在长时间连接传输大块数据时效率才最高。`HTTP 2.0` 通过让所有数据流共用同一个连接，可以更有效地使用 `TCP` 连接，让高带宽也能真正的服务于 `HTTP` 的性能提升。 同时，单链接多资源的方式，使到至上而下的层面都得到了好处：

1. 可以减少服务链接压力,内存占用少了,连接吞吐量大了
2. 由于 `TCP` 连接减少而使网络拥塞状况得以改观;
3. 慢启动时间减少,拥塞和丢包恢复速度更快。

**也就是说，“资源合并减少请求”的优化手段对于 HTTP2.0 来说是没有效果的，只会增大无用的工作量而已。**

### 并行双向字节流的请求和响应

在 HTTP2.0 上，客户端和服务器可以把 HTTP 消息分解为互不依赖的帧，然后乱序发送，最后再在另一端把它们重新组合起来。注意，同一链接上有多个不同方向的数据流在传输。客户端可以一边乱序发送 stream，也可以一边接收服务器的响应，而服务器那端同理。把 HTTP 消息分解为独立的帧,交错发送,然后在另一端重新组装是 HTTP 2.0 最 重要的一项增强。事实上,这个机制会在整个 Web 技术栈中引发一系列连锁反应, 从而带来巨大的性能提升,因为:

1.  可以并行交错地发送请求,请求之间互不影响;
2.  可以并行交错地发送响应,响应之间互不干扰;
3.  只使用一个连接即可并行发送多个请求和响应;
4.  消除不必要的延迟,从而减少页面加载的时间;
    **那么也就是说“域名分区”这种优化手段对于 HTTP2.0 是无用的，因为资源都是并行交错发送，且没有限制，不需要额外的多域名并行下载。**

## 服务器推送

服务端可以在发送页面 HTML 时主动推送其它资源，而不用等到浏览器解析到相应位置，发起请求再响应。例如服务端可以主动把 JS 和 CSS 文件推送给客户端，而不需要客户端解析 HTML 时再发送这些请求。

有了 HTTP2.0 的服务器推送，HTTP1.x 时代的内嵌资源的优化手段也变得没有意义了。而且使用服务器推送的资源的方式更加高效，因为客户端还可以缓存起来，甚至可以由不同的页面共享（依旧遵循同源策略）。
服务端可以主动推送，客户端也有权利选择是否接收。如果服务端推送的资源已经被浏览器缓存过，浏览器可以通过发送 `RST_STREAM` 帧来拒收。主动推送也遵守同源策略，服务器不会随便推送第三方资源给客户端。

了解更多 Server Push 特性

## 头部压缩

HTTP 1.1 请求的大小变得越来越大，有时甚至会大于 TCP 窗口的初始大小，因为它们需要等待带着 ACK 的响应回来以后才能继续被发送。HTTP/2 对消息头采用 HPACK（专为 http/2 头部设计的压缩格式）进行压缩传输，能够节省消息头占用的网络的流量。而 HTTP/1.x 每次请求，都会携带大量冗余头信息，浪费了很多带宽资源。

HTTP 每一次通信都会携带一组头部，用于描述这次通信的的资源、浏览器属性、cookie 等，例如
![](https://github.com/fyuanfen/note/raw/master/images/network/http2-2.jpg)

为了减少这块的资源消耗并提升性能， **HTTP/2 对这些首部采取了压缩策略：**

- HTTP/2 在客户端和服务器端使用“首部表”来跟踪和存储之前发送的键－值对，对于相同的数据，不再通过每次请求和响应发送；
- 首部表在 HTTP/2 的连接存续期内始终存在，由客户端和服务器共同渐进地更新;
- 每个新的首部键－值对要么被追加到当前表的末尾，要么替换表中之前的值。
  例如：下图中的两个请求， 请求一发送了所有的头部字段，第二个请求则只需要发送差异数据，这样可以减少冗余数据，降低开销。

参考资料：
InterviewMap
[程序员面试必考题（二十五）---SPDY 与 HTTP/2 协议](https://www.jianshu.com/p/d352b4c9e26a)
Http 1.x 弊端与 Http 2.0 比较
[HTTP 2.0 与 HTTP 1.1 区别](https://www.cnblogs.com/frankyou/p/6145485.html)
[HTTP2.0 性能增强的核心：二进制分帧](https://blog.csdn.net/u011904605/article/details/53012844)
